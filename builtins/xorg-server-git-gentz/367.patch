From ffcca72ec7e886488803748dc063c4036838585c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 10:41:32 +0100
Subject: [PATCH 1/6] gitlab-ci: Use host-mapped directory for ccache

Same as done in Mesa.
---
 .gitlab-ci.yml | 10 +++-------
 1 file changed, 3 insertions(+), 7 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index d80e5e848..8ea7c8e47 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -53,20 +53,16 @@ debian-testing:
         when: on_failure
         paths:
             - build/test/piglit-results/
-    cache:
-        paths:
-            - ccache/
     variables:
+        CCACHE_COMPILERCHECK: content
+        CCACHE_DIR: /cache/xserver/cache
         LC_ALL: C.UTF-8
     before_script:
         - export CCACHE_BASEDIR="$PWD"
-        - export CCACHE_DIR="$PWD/ccache"
-        - export CCACHE_COMPILERCHECK=content
         - export PATH="/usr/lib/ccache:$PATH"
-        - ccache --zero-stats
         - ccache --show-stats
     after_script:
-        - CCACHE_DIR="$PWD/ccache" ccache --show-stats
+        - ccache --show-stats
 
 autotools-build-and-test:
     extends: .common-build-and-test
-- 
2.24.1


From 4e1c9f214e34dcdcaab29c3531b5db5d800b9f80 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 09:35:09 +0100
Subject: [PATCH 2/6] gitlab-ci: Use -j4 instead of -j$(proc)

The shared GitLab CI runners are configured for jobs making use of up
to 4 CPU cores, attempting to use more may overload them.
---
 .gitlab-ci.yml               | 10 +++++-----
 .gitlab-ci/debian-install.sh |  4 ++--
 2 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 8ea7c8e47..c705adeb7 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -18,7 +18,7 @@ variables:
     DEBIAN_VERSION: testing-slim
     DEBIAN_EXEC: 'bash .gitlab-ci/debian-install.sh'
 
-    DEBIAN_TAG: "2019-09-03"
+    DEBIAN_TAG: "2019-12-23"
     IMAGE_LOCAL: "$CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$DEBIAN_TAG"
 
 include:
@@ -70,8 +70,8 @@ autotools-build-and-test:
         - mkdir build/
         - cd build/
         - ../autogen.sh --prefix=/usr
-        - make -j$(nproc) distcheck
-        - PIGLIT_DIR=/root/piglit XTEST_DIR=/root/xts make -j$(nproc) check
+        - make -j4 distcheck
+        - PIGLIT_DIR=/root/piglit XTEST_DIR=/root/xts make -j4 check
         - cd ..
         - .gitlab-ci/manpages-check
 
@@ -82,6 +82,6 @@ meson-build-and-test:
         XTEST_DIR: /root/xts
     script:
         - meson -Dprefix=/usr -Dxephyr=true build/
-        - ninja -C build/ install
-        - ninja -C build/ test
+        - ninja -j4 -C build/ install
+        - ninja -j4 -C build/ test
         - .gitlab-ci/manpages-check
diff --git a/.gitlab-ci/debian-install.sh b/.gitlab-ci/debian-install.sh
index a17bccff2..176396316 100644
--- a/.gitlab-ci/debian-install.sh
+++ b/.gitlab-ci/debian-install.sh
@@ -20,13 +20,13 @@ git clone https://gitlab.freedesktop.org/mesa/piglit.git --depth 1
 git clone https://gitlab.freedesktop.org/xorg/test/xts --depth 1
 cd xts
 ./autogen.sh
-xvfb-run make -j$(nproc)
+xvfb-run make -j4
 cd ..
 
 git clone https://gitlab.freedesktop.org/xorg/test/rendercheck --depth 1
 cd rendercheck
 meson build
-ninja -C build install
+ninja -j4 -C build install
 cd ..
 
 rm -rf piglit/.git xts/.git
-- 
2.24.1


From 022ac7af73ca4bad198d19a934784079f2c9f145 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 09:51:43 +0100
Subject: [PATCH 3/6] gitlab-ci: Strip down docker image contents more

Making the image significantly smaller.
---
 .gitlab-ci/debian-install.sh | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/.gitlab-ci/debian-install.sh b/.gitlab-ci/debian-install.sh
index 176396316..8542a62af 100644
--- a/.gitlab-ci/debian-install.sh
+++ b/.gitlab-ci/debian-install.sh
@@ -29,12 +29,13 @@ meson build
 ninja -j4 -C build install
 cd ..
 
-rm -rf piglit/.git xts/.git
+rm -rf piglit/.git xts/.git piglit/tests/spec/
 
 echo '[xts]' > piglit/piglit.conf
 echo 'path=/root/xts' >> piglit/piglit.conf
 
-find -name \*.a -o -name \*.o | xargs rm
+find -name \*.a -o -name \*.o -o -name \*.c -o -name \*.h -o -name \*.la\* | xargs rm
+strip xts/xts5/*/.libs/*
 
 apt-get purge -y git libxkbcommon-dev \
     x11-utils x11-xserver-utils xauth xvfb
-- 
2.24.1


From 7dfb85c5c17cbf4cfac0e6a41610cedd71356b23 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 09:32:07 +0100
Subject: [PATCH 4/6] gitlab-ci: Use sorted lists of distro packages, one per
 line

This will make it easier to review changes.
---
 .gitlab-ci/debian-install.sh | 31 +++++++++++++++++++++++++------
 1 file changed, 25 insertions(+), 6 deletions(-)

diff --git a/.gitlab-ci/debian-install.sh b/.gitlab-ci/debian-install.sh
index 8542a62af..18e030541 100644
--- a/.gitlab-ci/debian-install.sh
+++ b/.gitlab-ci/debian-install.sh
@@ -6,10 +6,23 @@ set -o xtrace
 echo 'deb-src https://deb.debian.org/debian testing main' > /etc/apt/sources.list.d/deb-src.list
 apt-get update
 apt-get install -y \
-	meson git ca-certificates ccache automake autoconf libtool \
-	libxkbcommon-dev python3-mako python3-numpy python3-six \
-	x11-utils x11-xserver-utils xauth xvfb \
-        libgl1 libglx-mesa0
+	autoconf \
+	automake \
+	ca-certificates \
+	ccache \
+	git \
+	libgl1 \
+	libglx-mesa0 \
+	libtool \
+	libxkbcommon-dev \
+	meson \
+	python3-mako \
+	python3-numpy \
+	python3-six \
+	x11-utils \
+	x11-xserver-utils \
+	xauth \
+	xvfb \
 
 apt-get build-dep -y xorg-server
 
@@ -37,6 +50,12 @@ echo 'path=/root/xts' >> piglit/piglit.conf
 find -name \*.a -o -name \*.o -o -name \*.c -o -name \*.h -o -name \*.la\* | xargs rm
 strip xts/xts5/*/.libs/*
 
-apt-get purge -y git libxkbcommon-dev \
-    x11-utils x11-xserver-utils xauth xvfb
+apt-get purge -y \
+	git \
+	libxkbcommon-dev \
+	x11-utils \
+	x11-xserver-utils \
+	xauth \
+	xvfb \
+
 apt-get autoremove -y --purge
-- 
2.24.1


From 61a70a4d5e95052fe3b48a9441b3fca46feb7604 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 09:53:26 +0100
Subject: [PATCH 5/6] gitlab-ci: Install libnvidia-egl-wayland-dev package

In order to build-test the Xwayland eglstream code.
---
 .gitlab-ci/debian-install.sh | 1 +
 1 file changed, 1 insertion(+)

diff --git a/.gitlab-ci/debian-install.sh b/.gitlab-ci/debian-install.sh
index 18e030541..845b49581 100644
--- a/.gitlab-ci/debian-install.sh
+++ b/.gitlab-ci/debian-install.sh
@@ -13,6 +13,7 @@ apt-get install -y \
 	git \
 	libgl1 \
 	libglx-mesa0 \
+	libnvidia-egl-wayland-dev \
 	libtool \
 	libxkbcommon-dev \
 	meson \
-- 
2.24.1


From bea53471f538d90eaaed5dcc7c9065d265d876ad Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <mdaenzer@redhat.com>
Date: Mon, 23 Dec 2019 09:26:17 +0100
Subject: [PATCH 6/6] xwayland: Include xwayland-window.h from
 xwayland-glamor-eglstream.c

Fixes build failure.

Closes: https://gitlab.freedesktop.org/xorg/xserver/issues/954
Fixes: 89e32d00f6e0 "xwayland: Move Xwayland windows to its own sources"
---
 hw/xwayland/xwayland-glamor-eglstream.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/hw/xwayland/xwayland-glamor-eglstream.c b/hw/xwayland/xwayland-glamor-eglstream.c
index 81947a6ba..aa5267a4d 100644
--- a/hw/xwayland/xwayland-glamor-eglstream.c
+++ b/hw/xwayland/xwayland-glamor-eglstream.c
@@ -43,6 +43,7 @@
 #include "xwayland-glamor.h"
 #include "xwayland-pixmap.h"
 #include "xwayland-screen.h"
+#include "xwayland-window.h"
 
 #include "wayland-eglstream-client-protocol.h"
 #include "wayland-eglstream-controller-client-protocol.h"
-- 
2.24.1

